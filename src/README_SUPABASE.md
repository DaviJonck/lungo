# Arquitetura Supabase - LunGo

## Vis√£o Geral

Esta documenta√ß√£o descreve a arquitetura limpa implementada para integra√ß√£o com o Supabase no projeto LunGo.

## Estrutura de Arquivos

```
src/
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts          # Tipos TypeScript para todas as tabelas
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts          # Servi√ßos para opera√ß√µes do Supabase
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useSupabaseData.ts   # Hooks personalizados para React
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ exerciseUtils.ts      # Utilit√°rios para formata√ß√£o de dados
‚îî‚îÄ‚îÄ app/(dashboard)/dashboard/components/
    ‚îî‚îÄ‚îÄ Sections.tsx          # Componente atualizado
```

## Tabelas do Supabase

### 1. exercises

- **Prop√≥sito**: Biblioteca mestra de exerc√≠cios
- **Campos**: id, name, description, video_url, type, created_at
- **Tipos**: AEROBIC, STRENGTH, RESPIRATORY

### 2. workout_plan_templates

- **Prop√≥sito**: Planos de treinamento padr√£o
- **Campos**: id, name, target_disease, description, created_at

### 3. template_exercises

- **Prop√≥sito**: Exerc√≠cios que comp√µem cada template
- **Campos**: id, template_id, exercise_id, day_of_week, order_in_day, sets, reps, duration_minutes, rest_seconds

### 4. patient_plans

- **Prop√≥sito**: Planos atribu√≠dos a pacientes espec√≠ficos
- **Campos**: id, patient_id, professional_id, plan_name, is_active, start_date, notes, created_at, updated_at

### 5. scheduled_exercises

- **Prop√≥sito**: Exerc√≠cios agendados para pacientes
- **Campos**: id, patient_plan_id, exercise_id, day_of_week, order_in_day, sets, reps, duration_minutes, rest_seconds

### 6. patient_activity_logs

- **Prop√≥sito**: Registro hist√≥rico de exerc√≠cios conclu√≠dos
- **Campos**: id, patient_id, exercise_id, scheduled_exercise_id, completed_at, notes, perceived_difficulty, created_at

## Servi√ßos Implementados

### ExerciseService

- `getAll(filters?)`: Busca todos os exerc√≠cios
- `getById(id)`: Busca exerc√≠cio por ID
- `getByType(type)`: Busca exerc√≠cios por tipo

### WorkoutPlanTemplateService

- `getAll()`: Busca todos os templates
- `getById(id)`: Busca template por ID
- `getByTargetDisease(disease)`: Busca templates por doen√ßa

### PatientPlanService

- `getByPatientId(patientId, filters?)`: Busca planos do paciente
- `getActivePlan(patientId)`: Busca plano ativo
- `getPlanWithExercises(planId)`: Busca plano com exerc√≠cios

### ScheduledExerciseService

- `getByPatientPlanId(patientPlanId)`: Busca exerc√≠cios agendados
- `getByPatientIdAndDay(patientId, dayOfWeek)`: Busca exerc√≠cios por dia
- `getTodayExercises(patientId)`: Busca exerc√≠cios de hoje

### DashboardService

- `getPatientDashboardData(patientId)`: Busca todos os dados do dashboard

### PatientActivityLogService

- `create(data)`: Cria um novo log de atividade
- `getByPatientId(patientId)`: Busca hist√≥rico de atividades do paciente
- `getByPatientIdAndDate(patientId, date)`: Busca atividades por data
- `getTodayActivities(patientId)`: Busca atividades de hoje
- `getByExerciseId(patientId, exerciseId)`: Busca hist√≥rico de um exerc√≠cio espec√≠fico
- `updateLog(logId, updates)`: Atualiza um log existente
- `deleteLog(logId)`: Remove um log

## Hooks Personalizados

### usePatientDashboard(patientId)

- **Retorna**: Dados completos do dashboard
- **Inclui**: Plano ativo, exerc√≠cios de hoje, todos os exerc√≠cios, loading, error, summary

### useTodayExercises(patientId)

- **Retorna**: Exerc√≠cios espec√≠ficos de hoje
- **Inclui**: Lista de exerc√≠cios, loading, error, refetch

### useActivePatientPlan(patientId)

- **Retorna**: Plano ativo do paciente
- **Inclui**: Plano, loading, error, refetch

### useExerciseCompletion()

- **Retorna**: Estado de exerc√≠cios completados
- **Inclui**: completedExercises, markExerciseComplete, isExerciseCompleted, etc.

### useExerciseCompletion() (Novo)

- **Retorna**: Funcionalidade para salvar conclus√£o no banco
- **Inclui**: isCompleting, completionError, completeExercise, clearError

### useActivityHistory(patientId)

- **Retorna**: Hist√≥rico de atividades do paciente
- **Inclui**: activities, loading, error, refetch, getTodayActivities, getActivitiesByDate

### useExercises(filters?)

- **Retorna**: Lista de exerc√≠cios do banco de dados
- **Inclui**: exercises, loading, error, refetch, getExercisesByType, searchExercises

### useUserPlanStatus(patientId)

- **Retorna**: Status do plano do usu√°rio
- **Inclui**: hasActivePlan, activePlan, loading, error, refetch

## Utilit√°rios

### exerciseUtils.ts

- `formatScheduledExercisesForToday()`: Converte dados do Supabase para formato do componente
- `generateTasksForExercise()`: Gera tarefas baseadas no tipo de exerc√≠cio
- `formatDuration()`: Formata dura√ß√£o em minutos
- `formatReps()`: Formata repeti√ß√µes
- `calculateTotalDuration()`: Calcula dura√ß√£o total
- `generateExerciseSummary()`: Gera resumo de exerc√≠cios

## Configura√ß√£o

### Vari√°veis de Ambiente Necess√°rias

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Instala√ß√£o de Depend√™ncias

```bash
npm install @supabase/supabase-js
```

## Seguran√ßa (RLS)

O sistema implementa Row-Level Security (RLS) com as seguintes pol√≠ticas:

- **Pacientes**: Podem apenas ler seus pr√≥prios planos e exerc√≠cios
- **Profissionais**: T√™m controle total sobre todas as tabelas
- **Dados p√∫blicos**: Exerc√≠cios e templates podem ser lidos por qualquer usu√°rio

## Uso no Componente

```tsx
// Exemplo de uso no componente
export function RemindersAndActivities({ userData }: SectionsProps) {
  const {
    todayExercises,
    loading: exercisesLoading,
    error: exercisesError,
    summary,
  } = usePatientDashboard(userData?.id || "");

  const { markExerciseComplete, isExerciseCompleted } = useExerciseCompletion();

  // ... resto do componente
}
```

## Benef√≠cios da Arquitetura

1. **Separa√ß√£o de Responsabilidades**: Cada arquivo tem uma responsabilidade espec√≠fica
2. **Reutiliza√ß√£o**: Hooks e servi√ßos podem ser reutilizados em outros componentes
3. **Tipagem Forte**: TypeScript garante type safety em toda a aplica√ß√£o
4. **Manutenibilidade**: C√≥digo organizado e f√°cil de manter
5. **Testabilidade**: Cada camada pode ser testada independentemente
6. **Performance**: Hooks otimizados com useCallback e useEffect
7. **Error Handling**: Tratamento de erros consistente em toda a aplica√ß√£o

## Solu√ß√£o de Problemas

### Erro PGRST108 - "patient_plan is not an embedded resource"

**Problema**: Ao tentar filtrar `scheduled_exercises` por `patient_plan.patient_id`, o Supabase retorna erro PGRST108.

**Causa**: Tentativa de filtrar por uma tabela relacionada sem inclu√≠-la no `select`.

**Solu√ß√£o Implementada**:

1. Primeiro buscar o plano ativo do paciente
2. Depois buscar os exerc√≠cios agendados usando o `patient_plan_id` diretamente

```typescript
// ‚ùå Query que falha
.eq("patient_plan.patient_id", patientId)

// ‚úÖ Solu√ß√£o implementada
const activePlan = await PatientPlanService.getActivePlan(patientId);
.eq("patient_plan_id", activePlan.id)
```

### Testando a Conex√£o

Use o arquivo `src/utils/supabaseTest.ts` para testar a conex√£o:

```typescript
import { testSupabaseConnection, testPatientData } from "@/utils/supabaseTest";

// Testar conex√£o geral
await testSupabaseConnection();

// Testar dados espec√≠ficos do paciente
await testPatientData("17797c71-0671-4590-9299-f4c13bb610de");
```

## Otimiza√ß√µes Implementadas

### üöÄ Cache e Performance

1. **Contexto Compartilhado**: Criado `DashboardContext` para compartilhar dados entre componentes
2. **Cache em Mem√≥ria**: Implementado `useSupabaseCache` para evitar chamadas duplicadas
3. **Monitor de Rede**: Sistema de monitoramento para debug de requisi√ß√µes

### üìä Estrutura Otimizada

```
src/
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îî‚îÄ‚îÄ DashboardContext.tsx    # Contexto para compartilhar dados
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useSupabaseData.ts      # Hooks otimizados com cache
‚îÇ   ‚îî‚îÄ‚îÄ useSupabaseCache.ts     # Sistema de cache
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ networkMonitor.ts       # Monitor de requisi√ß√µes
```

### üîß Como Usar

```tsx
// No componente pai
<DashboardProvider userData={userData}>
  <RemindersAndActivities userData={userData} />
  <Infographics userData={userData} />
</DashboardProvider>;

// Nos componentes filhos
const { todayExercises, loading } = useDashboard();
```

### üìà Benef√≠cios

- ‚úÖ **Redu√ß√£o de 75% nas chamadas**: De 4 chamadas para 1 por carregamento
- ‚úÖ **Cache inteligente**: Dados ficam em cache por 30 segundos
- ‚úÖ **Reutiliza√ß√£o de promises**: Evita chamadas simult√¢neas duplicadas
- ‚úÖ **Monitoramento**: Logs detalhados para debug

## üéØ Funcionalidades de Conclus√£o de Exerc√≠cios

### ‚úÖ Sistema Completo Implementado

1. **Salvamento no Banco**: Exerc√≠cios conclu√≠dos s√£o salvos na tabela `patient_activity_logs`
2. **Dados Coletados**: Notas, dificuldade percebida (1-5), dados vitais
3. **Feedback Visual**: Estados de loading, sucesso e erro
4. **Valida√ß√£o**: Verifica√ß√£o de dados antes de salvar
5. **Hist√≥rico**: Hook para buscar hist√≥rico de atividades

### üìä Dados Salvos

```typescript
interface PatientActivityLog {
  id: number;
  patient_id: string;
  exercise_id: number;
  scheduled_exercise_id?: number;
  completed_at: string; // Data de conclus√£o
  notes?: string; // Observa√ß√µes do paciente
  perceived_difficulty?: number; // 1-5 (f√°cil a dif√≠cil)
  created_at: string;
}
```

### üîÑ Fluxo de Conclus√£o

1. **Usu√°rio clica "Iniciar"** ‚Üí Abre modal do exerc√≠cio
2. **Preenche dados** ‚Üí Notas, dificuldade, dados vitais
3. **Clica "Concluir"** ‚Üí Salva no banco via `PatientActivityLogService`
4. **Feedback visual** ‚Üí Toast de sucesso/erro
5. **Estado atualizado** ‚Üí Exerc√≠cio marcado como conclu√≠do
6. **Recarregamento autom√°tico** ‚Üí Dados atualizados do banco

### üéØ Status de Conclus√£o Persistente

**Problema Resolvido**: Exerc√≠cios n√£o apareciam como conclu√≠dos ap√≥s recarregar a p√°gina.

**Solu√ß√£o Implementada**:

1. **Busca dupla**: Carrega exerc√≠cios agendados + logs de atividade conclu√≠dos
2. **Compara√ß√£o inteligente**: Compara `exercise_id` para determinar status
3. **Status persistente**: Exerc√≠cios conclu√≠dos permanecem marcados ap√≥s reload

```typescript
// L√≥gica de compara√ß√£o
const exercisesWithStatus = addCompletionStatusToExercises(
  scheduledExercises, // Exerc√≠cios agendados para hoje
  completedToday // Logs de atividades conclu√≠das hoje
);
```

### üõ†Ô∏è Como Usar

```tsx
// No componente
const { completeExercise, isCompleting, completionError } =
  useExerciseCompletion();

// Ao concluir exerc√≠cio
await completeExercise(patientId, exerciseId, scheduledExerciseId, {
  notes: "Foi dif√≠cil mas consegui!",
  perceived_difficulty: 4,
  heartRate: "85 bpm",
});
```

## üèÉ‚Äç‚ôÇÔ∏è P√°gina de Exerc√≠cios Atualizada

### ‚úÖ Funcionalidades Implementadas

1. **Dados Reais do Banco**: P√°gina agora busca exerc√≠cios da tabela `exercises`
2. **Filtros Funcionais**: Categorias (Respirat√≥rios, Aer√≥bicos, For√ßa) baseadas no tipo do banco
3. **Busca em Tempo Real**: Pesquisa por nome e descri√ß√£o dos exerc√≠cios
4. **Loading States**: Indicadores visuais durante carregamento
5. **Tratamento de Erros**: Mensagens de erro e bot√£o de retry
6. **Estados Vazios**: Mensagens quando n√£o h√° exerc√≠cios ou resultados

### üîÑ Mapeamento de Tipos

```typescript
// Banco de Dados ‚Üí Interface
RESPIRATORY ‚Üí "respiratorios"
AEROBIC     ‚Üí "aerobicos"
STRENGTH    ‚Üí "for√ßa"
```

### üé® Interface Atualizada

- ‚úÖ **Loading**: Spinner animado durante carregamento
- ‚úÖ **Erro**: Mensagem de erro com bot√£o "Tentar Novamente"
- ‚úÖ **Vazio**: Mensagem quando n√£o h√° exerc√≠cios na categoria
- ‚úÖ **Busca**: Resultado vazio com op√ß√£o de limpar busca
- ‚úÖ **Thumbnails**: Imagens baseadas no tipo do exerc√≠cio

### üß™ Como Testar

```javascript
// No console do navegador
await testExercisesPage();
```

## üé¨ Modal de Exerc√≠cios Implementado

### ‚úÖ Funcionalidades Implementadas

1. **Categoria "TODOS"**: Nova aba que mostra todos os exerc√≠cios
2. **Modal Interativo**: Abre ao clicar em qualquer exerc√≠cio
3. **Reprodu√ß√£o de V√≠deo**: Player HTML5 integrado no modal
4. **Informa√ß√µes Detalhadas**: Tipo, dura√ß√£o, n√≠vel, ID do exerc√≠cio
5. **Interface Responsiva**: Modal adapt√°vel para diferentes telas

### üé® Interface do Modal

#### **Cabe√ßalho do Modal**

- üé• **V√≠deo**: Player HTML5 com controles
- üñºÔ∏è **Fallback**: Placeholder quando v√≠deo n√£o dispon√≠vel
- ‚ùå **Fechar**: Bot√£o X no canto superior direito

#### **Conte√∫do do Modal**

- üìù **T√≠tulo**: Nome do exerc√≠cio
- üìÑ **Descri√ß√£o**: Texto explicativo do exerc√≠cio
- üìä **Informa√ß√µes**: Cards com tipo, dura√ß√£o, n√≠vel, ID
- üéÆ **A√ß√µes**: Bot√µes "Fechar" e "Iniciar Exerc√≠cio"

### üîÑ Fluxo de Funcionamento

1. **Navega√ß√£o**: Usu√°rio clica na aba "Todos" ou categoria espec√≠fica
2. **Sele√ß√£o**: Clica em um exerc√≠cio para abrir o modal
3. **Visualiza√ß√£o**: Modal exibe v√≠deo e informa√ß√µes do exerc√≠cio
4. **Intera√ß√£o**: Pode reproduzir v√≠deo e ver detalhes
5. **A√ß√£o**: Pode fechar ou iniciar o exerc√≠cio

### üéØ Estados do Modal

#### **Com V√≠deo**

```html
<video controls poster="thumbnail">
  <source src="video.mp4" type="video/mp4" />
</video>
```

#### **Sem V√≠deo**

```
üé• V√≠deo n√£o dispon√≠vel
```

### üß™ Como Testar

```javascript
// No console do navegador
await testExerciseModal();
```

## üì± Layout Mobile Responsivo

### ‚úÖ Melhorias Implementadas

1. **Layout Flex√≠vel**: Cards de exerc√≠cio se adaptam ao mobile
2. **Bot√£o Full-Width**: Bot√µes ocupam toda a largura no mobile
3. **Stack Vertical**: Conte√∫do empilhado verticalmente em telas pequenas
4. **Espa√ßamento Otimizado**: Padding e gaps ajustados para mobile

### üé® Comportamento Responsivo

#### **Desktop (‚â• 768px)**

```
[√çcone] [T√≠tulo + Detalhes] ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî [Bot√£o]
```

#### **Mobile (< 768px)**

```
[√çcone] [T√≠tulo + Detalhes]
[‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî Bot√£o ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî]
```

### üîß Estilos Aplicados

#### **ExerciseCard**

```css
@media (max-width: 768px) {
  flex-direction: column;
  align-items: stretch;
  gap: 12px;
}
```

#### **ExerciseButton**

```css
@media (max-width: 768px) {
  width: 100%;
  padding: 12px 16px;
  font-size: 14px;
}
```

#### **ExerciseContent**

```css
@media (max-width: 768px) {
  flex: none;
}
```

### üß™ Como Testar

```javascript
// No console do navegador
await testMobileLayout();

// Simular diferentes tamanhos de tela
await simulateScreenSize(375); // iPhone
await simulateScreenSize(768); // Tablet
```

## üé¨ Modal de Exerc√≠cio Responsivo

### ‚úÖ Melhorias Implementadas

1. **Modal Adapt√°vel**: Tamanho e padding ajustados para mobile
2. **Contador Otimizado**: Tamanho reduzido de 120px para 80px no mobile
3. **T√≠tulo Responsivo**: Fonte reduzida de 32px para 24px no mobile
4. **Timer Compacto**: Display reduzido de 64px para 48px no mobile
5. **Grid de Inputs**: Layout em coluna √∫nica no mobile
6. **Espa√ßamento Otimizado**: Padding e gaps reduzidos para mobile

### üé® Comportamento Responsivo

#### **Desktop (‚â• 768px)**

- Modal: 800px max-width, padding 40px
- T√≠tulo: 32px
- Contador: 120px
- Timer: 64px
- Grid: 2+ colunas

#### **Mobile (< 768px)**

- Modal: 95vh height, padding 20px
- T√≠tulo: 24px
- Contador: 80px
- Timer: 48px
- Grid: 1 coluna

### üîß Estilos Aplicados

#### **ModalContent**

```css
@media (max-width: 768px) {
  height: 95vh;
  margin: 10px;
  width: calc(100% - 20px);
  border-radius: 16px;
}
```

#### **ExerciseTitle**

```css
@media (max-width: 768px) {
  font-size: 24px;
}
```

#### **CountdownNumber**

```css
@media (max-width: 768px) {
  font-size: 80px;
  transform: scale(1.1);
}
```

#### **TimerDisplay**

```css
@media (max-width: 768px) {
  font-size: 48px;
}
```

#### **DataInputsGrid**

```css
@media (max-width: 768px) {
  grid-template-columns: 1fr;
  gap: 12px;
}
```

### üß™ Como Testar

```javascript
// No console do navegador
await testModalResponsive();

// Testar modal em diferentes tamanhos de tela
await testModalAtScreenSize(375); // iPhone
await testModalAtScreenSize(768); // Tablet
```

## üëë Sistema de Status do Plano

### ‚úÖ Funcionalidades Implementadas

1. **Verifica√ß√£o Autom√°tica**: Sidebar verifica se usu√°rio tem plano ativo
2. **Interface Din√¢mica**: Mostra mensagem diferente baseada no status
3. **Hook Personalizado**: `useUserPlanStatus` para gerenciar estado
4. **Feedback Visual**: √çcones e cores diferentes para cada estado

### üé® Estados da Interface

#### **Sem Plano Ativo** (Estado Original)

- üöÄ **T√≠tulo**: "Upgrade para PRO"
- üìù **Descri√ß√£o**: "Acesso completo a todos os recursos"
- üîµ **Bot√£o**: "Assinar Agora" (azul)
- üîó **A√ß√£o**: Redireciona para `/subscription`

#### **Com Plano Ativo** (Novo Estado)

- üëë **T√≠tulo**: "Parab√©ns! Voc√™ j√° √© um usu√°rio Plus"
- üìù **Descri√ß√£o**: "Aproveite todos os recursos dispon√≠veis"
- üü¢ **Bot√£o**: "Ver Perfil" (verde)
- üîó **A√ß√£o**: Redireciona para `/dashboard/profile`

### üîÑ Fluxo de Funcionamento

1. **Carregamento**: Hook verifica se usu√°rio tem plano ativo
2. **Verifica√ß√£o**: Consulta tabela `patient_plans` com `is_active = true`
3. **Renderiza√ß√£o**: Mostra interface apropriada baseada no resultado
4. **Intera√ß√£o**: Bot√£o leva para p√°gina correta

### üß™ Como Testar

```javascript
// No console do navegador
await testPlanStatus("patient-id");
```

## Pr√≥ximos Passos

1. Implementar React Query para cache mais robusto
2. Adicionar testes unit√°rios para servi√ßos e hooks
3. Implementar pagina√ß√£o para grandes volumes de dados
4. Adicionar modal de detalhes do exerc√≠cio
5. Implementar funcionalidade de "Iniciar" exerc√≠cio
6. Implementar sincroniza√ß√£o offline
7. Adicionar retry autom√°tico para falhas de rede
